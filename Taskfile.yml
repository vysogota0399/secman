version: '3'

env:
  ROOT_TOKEN: "I5gVSOrW5Fb4G+2iRMcFkj3+cSuWrBB+foUcXZzGhkI="
  JWT_TOKEN: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJzeXMvdXNlcnMvdXNlcjEiLCJleHAiOjIwNjMyMDEwMDUsImlhdCI6MTc0Nzg0MTAwNSwiU2lkIjoiOWI0MTlhOWItZjlhNS00OTQ5LThkMGQtZTMyNTY4ZDM3ZjQ2In0.lj3W5DyXEslgxTmDuli0nj3hXmKaxV7FmwUeqV44uuI'

tasks:
  status:
    cmd: curl http://127.0.0.1:8080/api/sys/status

  init:
    cmd: curl -v -X POST http://127.0.0.1:8080/api/sys/init

  unseal:
    cmd: 'curl -v -X POST -d "{\"key\": \"$ROOT_TOKEN\"}" -H "X-Secman-Token: $ROOT_TOKEN" http://127.0.0.1:8080/api/sys/unseal | jq'

  enable-*:
    vars:
      ENGINE: '{{index .MATCH 0}}'
    cmds:
      - 'curl -v -X POST -H "X-Secman-Token: $ROOT_TOKEN" http://127.0.0.1:8080/api/sys/engines/enable/{{.ENGINE}} -d "{}" | jq'

  auth-params:
    cmds:
      - 'curl -H "Authorization: Bearer $JWT_TOKEN" -v http://127.0.0.1:8080/api/engine/auth/logopass/ | jq'

  enable_auth-*:
    vars:
      ENGINE: '{{index .MATCH 0}}'
    cmds:
      - 'curl -v -X POST -H "X-Secman-Token: $ROOT_TOKEN" http://127.0.0.1:8080/api/sys/auth/enable -d "{\"engine_path\": \"{{.ENGINE}}\"}" | jq'

  login:
    cmds:
      - "curl -v -X POST -d '{\"login\": \"user1\", \"password\": \"qwerty$4\"}'  http://127.0.0.1:8080/api/engine/auth/logopass/login| jq"

  register:
    cmds:
      - "curl -v -X POST -d '{\"login\": \"user1\", \"password\": \"qwerty$4\"}'  http://127.0.0.1:8080/api/engine/auth/logopass/register| jq"

  run:
    cmds:
      - go build cmd/server/main.go
      - mv main secman
      - ./secman

  genmock-*:
    desc: exec "task genmock-OrdersRepository -- internal/server/entities"
          then rename internal/server/entities/mocks/CreateOrderService to snake case
    vars:
      STRUCT: '{{index .MATCH 0}}'
    cmds:
      - mockgen -package=mocks -destination=pkg/mocks/{{.CLI_ARGS}}/{{.STRUCT}}.go github.com/vysogota0399/secman/{{.CLI_ARGS}} {{.STRUCT}}

  test_coverage:
    cmds:
      - go clean -testcache
      - go test -count 1 ./... -coverprofile=coverage.out
      - go tool cover -func=coverage.out
      - rm coverage.out

  create-secret:
    cmds:
      - 'curl -v -X POST -H "Authorization: Bearer $JWT_TOKEN" http://127.0.0.1:8080/api/engine/secrets/kv -d "{\"key\": \"test\", \"value\": \"test\"}" | jq'

  get-secret:
    cmds:
      - 'curl -v -H "Authorization: Bearer $JWT_TOKEN" http://127.0.0.1:8080/api/engine/secrets/kv/test | jq'

  get-secret-params:
    cmds:
      - 'curl -v -H "Authorization: Bearer $JWT_TOKEN" http://127.0.0.1:8080/api/engine/secrets/kv/test/params | jq'

  update-secret-params:
    cmds:
      - 'curl -v -X PUT -H "Authorization: Bearer $JWT_TOKEN" http://127.0.0.1:8080/api/engine/secrets/kv/test/params -d "{\"metadata\": {\"lorem\": \"ipsum\"}}" | jq'

  create-card:
    cmds:
      - 'curl -v -X POST -H "Authorization: Bearer $JWT_TOKEN" http://127.0.0.1:8080/api/engine/secrets/pci_dss -d "{\"card_data\": {\"pan\": \"1234567890123458\", \"cardholder_name\": \"John Doe\", \"expiry_date\": \"2025-01-01T00:00:00Z\"}}" | jq'
  
